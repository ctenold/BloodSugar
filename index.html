<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#7c9885">
  <meta name="description" content="Glucose Journal - A peaceful way to track and monitor your blood sugar levels">
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Glucose Journal" />
  <link rel="manifest" href="site.webmanifest" />
  <title>Glucose Journal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #faf9f7;
      --bg-secondary: #f4f2ef;
      --bg-card: #ffffff;
      --text-primary: #2d3436;
      --text-secondary: #636e72;
      --text-muted: #a0a8ab;
      --border-color: #e8e4df;
      --shadow: rgba(45, 52, 54, 0.06);
      --shadow-lg: rgba(45, 52, 54, 0.12);
      --primary: #7c9885;
      --primary-dark: #5d7a66;
      --primary-light: #a8c5b0;
      --success: #7c9885;
      --warning: #d4a574;
      --danger: #c47f7f;
      --in-range: rgba(124, 152, 133, 0.12);
      --warning-zone: rgba(212, 165, 116, 0.12);
      --danger-zone: rgba(196, 127, 127, 0.12);
      --accent-blush: #e8d5d0;
      --accent-sage: #d4e2d7;
      --accent-cream: #f5f0e8;
      --gradient-peaceful: linear-gradient(135deg, #d4e2d7 0%, #e8d5d0 50%, #f5f0e8 100%);
      --gradient-card: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
    }

    [data-theme="dark"] {
      --bg-primary: #1a1d1e;
      --bg-secondary: #232728;
      --bg-card: #2a2f31;
      --text-primary: #e8e4df;
      --text-secondary: #a0a8ab;
      --text-muted: #636e72;
      --border-color: #3d4447;
      --shadow: rgba(0,0,0,0.25);
      --shadow-lg: rgba(0,0,0,0.4);
      --primary: #8fae98;
      --primary-dark: #7c9885;
      --primary-light: #a8c5b0;
      --in-range: rgba(143, 174, 152, 0.2);
      --warning-zone: rgba(212, 165, 116, 0.2);
      --danger-zone: rgba(196, 127, 127, 0.2);
      --accent-blush: #3d3533;
      --accent-sage: #2d3830;
      --accent-cream: #2f2d28;
      --gradient-peaceful: linear-gradient(135deg, #2d3830 0%, #3d3533 50%, #2f2d28 100%);
      --gradient-card: linear-gradient(180deg, rgba(42,47,49,0.95) 0%, rgba(42,47,49,0.85) 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.7;
      background: var(--bg-primary);
      color: var(--text-primary);
      padding-bottom: 80px;
      transition: background 0.5s ease, color 0.3s ease;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 400px;
      background: var(--gradient-peaceful);
      opacity: 0.4;
      z-index: -1;
      mask-image: linear-gradient(to bottom, black 0%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, black 0%, transparent 100%);
    }

    .container {
      max-width: 560px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      background: transparent;
      padding: 28px 20px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      opacity: 0.85;
      z-index: -1;
    }

    .header-content {
      max-width: 560px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.75em;
      font-weight: 500;
      color: var(--text-primary);
      letter-spacing: -0.02em;
      white-space: nowrap;
    }

    @media (max-width: 360px) {
      .header h1 {
        font-size: 1.4em;
      }
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .icon-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--shadow-lg);
    }

    /* Profile Setup Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(45, 52, 54, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 32px;
      max-width: 420px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 64px var(--shadow-lg);
      border: 1px solid var(--border-color);
      animation: slideUp 0.4s ease;
      position: relative;
    }

    .modal-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-secondary);
      border-radius: 50%;
      font-size: 1.4em;
      line-height: 1;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
      background: var(--primary);
      color: white;
    }

    .modal-header {
      margin-bottom: 24px;
      text-align: center;
    }

    .modal-header h2 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 1.75em;
      font-weight: 500;
    }

    .modal-header p {
      color: var(--text-secondary);
      font-size: 0.95em;
      line-height: 1.6;
    }

    .profile-option {
      background: var(--bg-secondary);
      border: 2px solid transparent;
      border-radius: 14px;
      padding: 18px 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-option:hover {
      border-color: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--shadow);
    }

    .profile-option.selected {
      border-color: var(--primary);
      background: var(--accent-sage);
    }

    .profile-option h3 {
      margin-bottom: 4px;
      font-size: 1.05em;
      font-weight: 600;
      color: var(--text-primary);
    }

    .profile-option p {
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    /* Today Widget */
    .today-widget {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .today-widget::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-peaceful);
    }

    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .widget-header h2 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.5em;
      font-weight: 500;
      color: var(--text-primary);
    }

    .share-btn {
      background: var(--accent-sage);
      border: 1px solid var(--border-color);
      color: var(--primary);
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .share-btn:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-lg);
    }

    /* Share Modal */
    .share-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 24px;
    }

    .share-option {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 18px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .share-option:hover {
      border-color: var(--primary);
      background: var(--in-range);
    }

    .share-option:hover .share-option-icon {
      background: var(--primary);
      color: white;
    }

    .share-option-icon {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: var(--accent-sage);
      color: var(--primary);
      transition: all 0.3s ease;
    }

    .share-option-icon svg {
      width: 18px;
      height: 18px;
    }

    .share-option-text {
      flex: 1;
    }

    .share-option-title {
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.95em;
      letter-spacing: -0.01em;
    }

    .share-preview {
      background: var(--accent-sage);
      border-radius: 16px;
      padding: 20px;
      margin-top: 8px;
      position: relative;
    }

    .share-preview::before {
      content: '"';
      position: absolute;
      top: 8px;
      left: 16px;
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2.5em;
      color: var(--primary);
      opacity: 0.3;
      line-height: 1;
    }

    .share-preview-label {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.75em;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .share-preview-text {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1em;
      color: var(--text-primary);
      line-height: 1.7;
      padding-left: 20px;
      white-space: pre-line;
    }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--primary);
      color: white;
      padding: 14px 28px;
      border-radius: 14px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9em;
      font-weight: 500;
      box-shadow: 0 8px 32px var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 2000;
      pointer-events: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .date-display {
      font-size: 0.9em;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .verse-box {
      background: var(--accent-sage);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      border-left: none;
      position: relative;
    }

    .verse-box::before {
      content: '"';
      position: absolute;
      top: 8px;
      left: 16px;
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 3em;
      color: var(--primary);
      opacity: 0.3;
      line-height: 1;
    }

    .verse-text {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-style: italic;
      font-size: 1.1em;
      line-height: 1.7;
      margin-bottom: 8px;
      color: var(--text-primary);
      padding-left: 24px;
    }

    .verse-ref {
      font-size: 0.85em;
      color: var(--primary);
      font-weight: 600;
      padding-left: 24px;
    }

    .status-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .status-text {
      font-size: 0.95em;
      color: var(--text-secondary);
    }

    .add-btn {
      background: var(--primary);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 600;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(124, 152, 133, 0.3);
    }

    .add-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124, 152, 133, 0.4);
    }

    /* Tag Indicators */
    .tag-indicators {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 16px;
    }

    .tag-indicator {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      border: 1px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .tag-indicator:hover:not(.logged) {
      border-color: var(--primary-light);
      background: var(--bg-card);
      transform: translateY(-1px);
    }

    .tag-indicator.logged {
      background: var(--in-range);
      border-color: var(--primary-light);
      color: var(--primary-dark);
      cursor: default;
      opacity: 0.7;
    }

    .tag-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .tag-indicator.logged .tag-dot {
      background: var(--primary);
    }

    /* Entry Form */
    .entry-form {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px var(--shadow);
      animation: slideUp 0.4s ease;
    }

    .entry-form h3 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      margin-bottom: 24px;
      color: var(--text-primary);
      font-size: 1.4em;
      font-weight: 500;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9em;
      letter-spacing: 0.02em;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1em;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--in-range);
      background: var(--bg-card);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .range-indicator {
      font-size: 0.85em;
      color: var(--text-secondary);
      margin-top: 8px;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border-radius: 10px;
      display: inline-block;
    }

    .range-indicator.in-range {
      background: var(--in-range);
      color: var(--success);
      font-weight: 600;
    }

    .range-indicator.warning {
      background: var(--warning-zone);
      color: var(--warning);
      font-weight: 600;
    }

    .range-indicator.danger {
      background: var(--danger-zone);
      color: var(--danger);
      font-weight: 600;
    }

    .btn-primary {
      width: 100%;
      padding: 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 1em;
      font-weight: 600;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(124, 152, 133, 0.3);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(124, 152, 133, 0.4);
    }

    .btn-secondary {
      width: 100%;
      padding: 14px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      font-size: 0.95em;
      font-weight: 500;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 12px;
    }

    .btn-secondary:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--in-range);
    }

    /* Chart Section */
    .chart-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px var(--shadow);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .chart-header h3 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      color: var(--text-primary);
      font-size: 1.4em;
      font-weight: 500;
    }

    .chart-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .chart-controls-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .chart-view-selector {
      display: flex;
      gap: 6px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 12px;
    }

    .view-btn {
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 0.8em;
      font-weight: 500;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .view-btn:hover {
      color: var(--text-primary);
      background: var(--bg-card);
    }

    .view-btn.active {
      background: var(--bg-card);
      color: var(--primary);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .time-range-selector {
      display: flex;
      gap: 6px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 12px;
    }

    .range-btn {
      padding: 8px 14px;
      background: transparent;
      border: none;
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 0.85em;
      font-weight: 500;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .range-btn:hover {
      color: var(--text-primary);
      background: var(--bg-card);
    }

    .range-btn.active {
      background: var(--bg-card);
      color: var(--primary);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .chart-filter-select {
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 0.85em;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
    }

    .chart-filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .chart-container {
      width: 100%;
      height: 300px;
      position: relative;
      margin: 20px 0;
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      align-items: center;
    }

    .legend-reset {
      font-size: 0.8em;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--primary);
      cursor: pointer;
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .legend-reset:hover {
      background: var(--bg-secondary);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .legend-item.disabled {
      opacity: 0.35;
    }

    .legend-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .legend-color {
      width: 24px;
      height: 3px;
      border-radius: 2px;
    }

    .legend-label {
      font-size: 0.85em;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-secondary);
    }

    /* Insights Panel */
    .insights-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px var(--shadow);
    }

    .insights-panel h3 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 1.4em;
      font-weight: 500;
    }

    .insight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }

    .insight-card {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px 16px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--shadow);
    }

    .insight-value {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.75em;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .insight-label {
      font-size: 0.8em;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Recent Readings */
    .recent-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px var(--shadow);
    }

    .recent-section h3 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 1.4em;
      font-weight: 500;
    }

    .reading-item {
      background: var(--bg-secondary);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      cursor: pointer;
    }

    .reading-item:hover {
      border-color: var(--border-color);
      background: var(--bg-card);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .reading-item:active {
      transform: translateY(0);
    }

    .reading-item.highlight {
      animation: highlightPulse 2s ease;
    }

    @keyframes highlightPulse {
      0%, 100% { background: var(--bg-secondary); }
      25%, 75% { background: var(--in-range); border-color: var(--primary); }
    }

    .reading-info {
      flex: 1;
    }

    .reading-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .reading-tag {
      font-weight: 600;
      font-size: 0.9em;
      color: var(--text-primary);
    }

    .reading-time {
      font-size: 0.8em;
      color: var(--text-muted);
    }

    .reading-value {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.5em;
      font-weight: 600;
      color: var(--text-primary);
    }

    .reading-value.in-range {
      color: var(--success);
    }

    .reading-value.warning {
      color: var(--warning);
    }

    .reading-value.danger {
      color: var(--danger);
    }

    .reading-notes {
      font-size: 0.85em;
      color: var(--text-secondary);
      margin-top: 6px;
      font-style: italic;
    }

    .delete-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1em;
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-btn:hover {
      color: var(--primary-dark);
      background: var(--accent-sage);
    }

    .delete-btn svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 1.5;
      fill: none;
    }

    .view-all-btn {
      display: block;
      width: 100%;
      margin-top: 16px;
      padding: 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 0.95em;
      font-weight: 500;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .view-all-btn:hover {
      background: var(--bg-card);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Full Log Modal */
    .full-log-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
      z-index: 1000;
      overflow-y: auto;
    }

    .full-log-modal.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .full-log-header {
      position: sticky;
      top: 0;
      background: var(--bg-primary);
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      z-index: 10;
    }

    .full-log-header-inner {
      max-width: 560px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .full-log-header h2 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.5em;
      font-weight: 500;
    }

    .full-log-close {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .full-log-close:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .full-log-content {
      max-width: 560px;
      margin: 0 auto;
      padding: 20px;
    }

    .full-log-filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .full-log-filters select,
    .full-log-filters input {
      flex: 1;
      min-width: 140px;
      padding: 10px 14px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 0.95em;
      cursor: pointer;
    }

    .full-log-filters input[type="month"]::-webkit-calendar-picker-indicator {
      filter: opacity(0.6);
      cursor: pointer;
    }

    .full-log-filters input[type="month"]::-webkit-datetime-edit {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .log-date-group {
      margin-bottom: 24px;
    }

    .log-date-header {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2em;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    /* Settings */
    .settings-section {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px var(--shadow);
    }

    .settings-section h3 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      margin-bottom: 20px;
      color: var(--text-primary);
      font-size: 1.4em;
      font-weight: 500;
    }

    .setting-item {
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-item .btn-secondary {
      padding: 10px 16px;
      margin-top: 8px;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .setting-label {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-weight: 500;
      font-size: 1.2em;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: block;
    }

    .setting-description {
      font-size: 0.9em;
      color: var(--text-secondary);
      margin-bottom: 8px;
      line-height: 1.6;
    }

    /* Target Ranges */
    .range-item {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
    }

    .range-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .range-item-name {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9em;
    }

    .range-item-badge {
      font-size: 0.75em;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--primary-light);
      color: var(--primary-dark);
    }

    .range-item-inputs {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .range-item-inputs input {
      width: 70px;
      padding: 6px 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.85em;
      text-align: center;
    }

    .range-item-inputs span {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    .range-item-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .range-btn {
      padding: 4px 10px;
      border: none;
      border-radius: 6px;
      font-size: 0.75em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .range-btn-save {
      background: var(--primary);
      color: white;
    }

    .range-btn-save:hover {
      background: var(--primary-dark);
    }

    .range-btn-reset {
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .range-btn-reset:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    /* Sync Modal */
    .sync-status {
      text-align: center;
      margin: 20px 0;
      font-size: 0.95em;
      color: var(--text-secondary);
    }

    .sync-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3.5em;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .empty-state-text {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.25em;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .empty-state-subtext {
      font-size: 0.95em;
      line-height: 1.6;
    }

    /* Custom Tag Form */
    .custom-tag-form {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 20px;
      margin-top: 16px;
      border: 1px solid var(--border-color);
    }

    .custom-tag-form h4 {
      margin-bottom: 16px;
      color: var(--text-primary);
      font-weight: 600;
    }

    .range-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 16px;
      }

      .header {
        padding: 20px 16px 16px;
      }

      .today-widget,
      .entry-form,
      .chart-section,
      .insights-panel,
      .recent-section,
      .settings-section {
        border-radius: 20px;
        padding: 24px 20px;
      }

      .chart-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .time-range-selector {
        width: 100%;
      }

      .range-btn {
        flex: 1;
        text-align: center;
      }

      .insight-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Selection colors */
    ::selection {
      background: var(--accent-sage);
      color: var(--text-primary);
    }

    /* Staggered card animations on load */
    .today-widget {
      animation: cardFadeIn 0.6s ease both;
      animation-delay: 0.1s;
    }

    .insights-panel {
      animation: cardFadeIn 0.6s ease both;
      animation-delay: 0.2s;
    }

    .chart-section {
      animation: cardFadeIn 0.6s ease both;
      animation-delay: 0.3s;
    }

    .recent-section {
      animation: cardFadeIn 0.6s ease both;
      animation-delay: 0.4s;
    }

    @keyframes cardFadeIn {
      from {
        opacity: 0;
        transform: translateY(16px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Focus states for accessibility */
    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Verse of the Day Modal */
    .verse-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(45, 52, 54, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.4s ease;
      padding: 20px;
    }

    .verse-modal.show {
      display: flex;
    }

    .verse-modal-content {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 40px 36px 36px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 32px 80px var(--shadow-lg);
      border: 1px solid var(--border-color);
      animation: slideUp 0.5s ease;
      position: relative;
      text-align: center;
    }

    .verse-modal-header {
      margin-bottom: 28px;
    }

    .verse-modal-header h2 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      color: var(--text-primary);
      font-size: 1.85em;
      font-weight: 500;
      letter-spacing: -0.01em;
    }

    .verse-modal-verse-box {
      background: var(--accent-sage);
      border-radius: 20px;
      padding: 32px 28px;
      margin-bottom: 32px;
      position: relative;
    }

    .verse-modal-verse-box::before {
      content: '"';
      position: absolute;
      top: 12px;
      left: 20px;
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 4em;
      color: var(--primary);
      opacity: 0.25;
      line-height: 1;
    }

    .verse-modal-text {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-style: italic;
      font-size: 1.25em;
      line-height: 1.8;
      color: var(--text-primary);
      padding-left: 16px;
      margin-bottom: 16px;
    }

    .verse-modal-ref {
      font-size: 0.95em;
      color: var(--primary);
      font-weight: 600;
      padding-left: 16px;
    }

    .verse-modal-btn {
      background: var(--primary);
      border: none;
      color: white;
      padding: 16px 48px;
      border-radius: 14px;
      cursor: pointer;
      font-size: 1.05em;
      font-weight: 600;
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(124, 152, 133, 0.35);
    }

    .verse-modal-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(124, 152, 133, 0.45);
    }

    @media (max-width: 600px) {
      .verse-modal-content {
        padding: 32px 24px 28px;
        border-radius: 20px;
      }

      .verse-modal-header h2 {
        font-size: 1.6em;
      }

      .verse-modal-verse-box {
        padding: 24px 20px;
      }

      .verse-modal-text {
        font-size: 1.15em;
      }

      .verse-modal-btn {
        padding: 14px 36px;
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1><img src="favicon.svg" alt="" style="height: 1.8em; vertical-align: bottom; margin-right: 0.4em;">Glucose Journal</h1>
      <div class="header-actions">
        <button class="icon-btn" id="themeToggle" aria-label="Toggle dark mode">☽</button>
        <button class="icon-btn" id="settingsBtn" aria-label="Settings">☰</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Today Widget -->
    <div class="today-widget" id="todayWidget">
      <div class="widget-header">
        <div>
          <h2>Today's Journey</h2>
          <div class="date-display" id="dateDisplay"></div>
        </div>
        <button class="share-btn" id="shareBtn" aria-label="Share today's verse" title="Share">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
        </button>
      </div>

      <div class="verse-box" id="verseBox">
        <div class="verse-text" id="verseText">Loading verse...</div>
        <div class="verse-ref" id="verseRef"></div>
      </div>

      <div class="status-summary">
        <div class="status-text" id="statusText">0 readings logged today</div>
        <button class="add-btn" onclick="showEntryForm()">Add Reading</button>
      </div>

      <div class="tag-indicators" id="tagIndicators"></div>
    </div>

    <!-- Entry Form -->
    <div class="entry-form hidden" id="entryForm">
      <h3>Log Reading</h3>
      <form id="readingForm">
        <div class="form-group">
          <label for="timestamp">Time</label>
          <input type="datetime-local" id="timestamp" required>
        </div>

        <div class="form-group">
          <label for="tag">Tag</label>
          <select id="tag" required>
            <option value="">Select a tag...</option>
            <option value="morning-fasting">Morning Fasting</option>
            <option value="post-breakfast1">Post-Breakfast (1hr)</option>
            <option value="post-breakfast2">Post-Breakfast (2hr)</option>
            <option value="pre-lunch">Pre-Lunch</option>
            <option value="post-lunch1">Post-Lunch (1hr)</option>
            <option value="post-lunch2">Post-Lunch (2hr)</option>
            <option value="pre-dinner">Pre-Dinner</option>
            <option value="post-dinner1">Post-Dinner (1hr)</option>
            <option value="post-dinner2">Post-Dinner (2hr)</option>
            <option value="custom">+ Add Custom Tag</option>
          </select>
        </div>

        <div class="custom-tag-form hidden" id="customTagForm">
          <h4>Create Custom Tag</h4>
          <div class="form-group">
            <label for="customTagName">Tag Name</label>
            <input type="text" id="customTagName" placeholder="e.g., Evening Snack">
          </div>
          <div class="range-inputs">
            <div class="form-group">
              <label for="customLow">Target Low (mg/dL)</label>
              <input type="number" id="customLow" value="70">
            </div>
            <div class="form-group">
              <label for="customHigh">Target High (mg/dL)</label>
              <input type="number" id="customHigh" value="140">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="reading">Blood Sugar (mg/dL)</label>
          <input type="number" id="reading" step="1" min="0" required placeholder="95">
          <div class="range-indicator" id="rangeIndicator"></div>
        </div>

        <div class="form-group">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="How are you feeling? What did you eat?"></textarea>
        </div>

        <button type="submit" class="btn-primary">Save Reading</button>
        <button type="button" class="btn-secondary" onclick="hideEntryForm()">Cancel</button>
      </form>
    </div>

    <!-- Insights Panel -->
    <div class="insights-panel" id="insightsPanel">
      <h3>Your Insights</h3>
      <div class="insight-grid">
        <div class="insight-card">
          <div class="insight-value" id="timeInRange">--</div>
          <div class="insight-label">Time in Range</div>
        </div>
        <div class="insight-card">
          <div class="insight-value" id="avgReading">--</div>
          <div class="insight-label">Avg Reading</div>
        </div>
        <div class="insight-card">
          <div class="insight-value" id="highReading">--</div>
          <div class="insight-label">Highest</div>
        </div>
        <div class="insight-card">
          <div class="insight-value" id="lowReading">--</div>
          <div class="insight-label">Lowest</div>
        </div>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-section" id="chartSection">
      <div class="chart-header">
        <h3>My Journey</h3>
      </div>
      <div class="chart-controls">
        <div class="chart-controls-row">
          <div class="chart-view-selector">
            <button class="view-btn active" data-view="all">All Tags</button>
            <button class="view-btn" data-view="date">By Date</button>
            <button class="view-btn" data-view="tag">By Tag</button>
          </div>
          <div class="time-range-selector" id="timeRangeSelector">
            <button class="range-btn active" data-days="7">7d</button>
            <button class="range-btn" data-days="14">14d</button>
            <button class="range-btn" data-days="30">30d</button>
            <button class="range-btn" data-days="90">90d</button>
          </div>
        </div>
        <div class="chart-controls-row" id="chartFilters" style="display: none;">
          <select class="chart-filter-select" id="dateFilter"></select>
          <select class="chart-filter-select" id="tagFilter"></select>
        </div>
      </div>
      <div class="chart-container"><canvas id="chart"></canvas></div>
      <div class="chart-legend" id="chartLegend"></div>
    </div>

    <!-- Recent Readings -->
    <div class="recent-section" id="recentSection">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin-bottom: 0;">Recent Readings</h3>
        <select id="recentTagFilter" class="chart-filter-select">
          <option value="all">All Tags</option>
        </select>
      </div>
      <div id="recentReadings"></div>
      <button class="view-all-btn" id="viewAllBtn" onclick="showFullLog()">View All Readings</button>
    </div>
  </div>

  <!-- Profile Setup Modal -->
  <div class="modal" id="profileModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Welcome</h2>
        <p>Select your profile for personalized glucose ranges tailored to your needs.</p>
      </div>
      <div class="profile-option" data-profile="male">
        <h3>Male</h3>
        <p>Standard blood sugar ranges</p>
      </div>
      <div class="profile-option" data-profile="female">
        <h3>Female (Non-pregnant)</h3>
        <p>Standard blood sugar ranges</p>
      </div>
      <div class="profile-option" data-profile="pregnant">
        <h3>Pregnant Female</h3>
        <p>Stricter ranges for gestational diabetes monitoring</p>
      </div>
      <button class="btn-primary" id="confirmProfile" disabled>Continue</button>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal" id="shareModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Share Encouragement</h2>
        <p>Pass along today's verse to someone who might need it</p>
      </div>

      <div class="share-preview" id="sharePreview">
        <div class="share-preview-label">Message Preview</div>
        <div class="share-preview-text" id="sharePreviewText"></div>
      </div>

      <div class="share-options">
        <div class="share-option" onclick="shareVia('copy')">
          <div class="share-option-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </div>
          <div class="share-option-text">
            <div class="share-option-title">Copy to Clipboard</div>
          </div>
        </div>

        <div class="share-option" onclick="shareVia('native')" id="nativeShareOption" style="display: none;">
          <div class="share-option-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </div>
          <div class="share-option-text">
            <div class="share-option-title">Share</div>
          </div>
        </div>

        <div class="share-option" onclick="shareVia('sms')">
          <div class="share-option-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="share-option-text">
            <div class="share-option-title">Text Message</div>
          </div>
        </div>

        <div class="share-option" onclick="shareVia('email')">
          <div class="share-option-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
          </div>
          <div class="share-option-text">
            <div class="share-option-title">Email</div>
          </div>
        </div>

        <div class="share-option" onclick="shareVia('whatsapp')">
          <div class="share-option-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
          </div>
          <div class="share-option-text">
            <div class="share-option-title">WhatsApp</div>
          </div>
        </div>

        <div class="share-option" onclick="shareVia('twitter')">
          <div class="share-option-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
            </svg>
          </div>
          <div class="share-option-text">
            <div class="share-option-title">Twitter</div>
          </div>
        </div>

        <div class="share-option" onclick="shareVia('facebook')">
          <div class="share-option-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
            </svg>
          </div>
          <div class="share-option-text">
            <div class="share-option-title">Facebook</div>
          </div>
        </div>
      </div>

      <button class="btn-secondary" onclick="closeShareModal()" style="margin-top: 24px;">Cancel</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="closeSettingsModal()" aria-label="Close">&times;</button>
      <div class="modal-header">
        <h2>Settings</h2>
      </div>

      <div class="settings-section">
        <div class="setting-item">
          <span class="setting-label">Profile</span>
          <p class="setting-description" id="currentProfile"></p>
          <button class="btn-secondary" onclick="changeProfile()">Change Profile</button>
        </div>

        <div class="setting-item">
          <span class="setting-label">Data Management</span>
          <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
            <div style="display: flex; gap: 8px;">
              <button class="btn-secondary" style="flex: 1;" onclick="downloadDataJSON()">Export JSON</button>
              <button class="btn-secondary" style="flex: 1;" onclick="downloadDataCSV()">Export CSV</button>
            </div>
            <p class="setting-description" style="margin: 4px 0;">JSON = full backup (settings + readings). CSV = readings only (Excel-friendly).</p>
            <div style="display: flex; gap: 8px;">
              <button class="btn-secondary" style="flex: 1;" onclick="document.getElementById('uploadInputJSON').click()">Import JSON</button>
              <button class="btn-secondary" style="flex: 1;" onclick="document.getElementById('uploadInputCSV').click()">Import CSV</button>
            </div>
            <input type="file" id="uploadInputJSON" accept=".json" style="display: none;" onchange="uploadDataJSON(event)">
            <input type="file" id="uploadInputCSV" accept=".csv" style="display: none;" onchange="uploadDataCSV(event)">
            <button class="btn-secondary" onclick="openSyncModal()">Sync with Google Drive</button>
          </div>
        </div>

        <div class="setting-item">
          <span class="setting-label">Custom Tags</span>
          <div id="customTagsList"></div>
        </div>

        <div class="setting-item">
          <span class="setting-label">Target Ranges</span>
          <p class="setting-description">Customize blood sugar target ranges for each tag</p>
          <div id="targetRangesList"></div>
        </div>
      </div>

      <button class="btn-primary" onclick="closeSettingsModal()">Close</button>
    </div>
  </div>

  <!-- Edit Reading Modal -->
  <div class="modal" id="editReadingModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Reading</h2>
        <p>Update your blood sugar entry</p>
      </div>
      <form id="editReadingForm">
        <input type="hidden" id="editReadingId">
        <div class="form-group">
          <label for="editTimestamp">Time</label>
          <input type="datetime-local" id="editTimestamp" required>
        </div>
        <div class="form-group">
          <label for="editTag">Tag</label>
          <select id="editTag" required></select>
        </div>
        <div class="form-group">
          <label for="editReading">Blood Sugar (mg/dL)</label>
          <input type="number" id="editReading" step="1" min="0" required>
        </div>
        <div class="form-group">
          <label for="editNotes">Notes (optional)</label>
          <textarea id="editNotes" placeholder="How are you feeling?"></textarea>
        </div>
        <div style="display: flex; gap: 12px;">
          <button type="submit" class="btn-primary" style="flex: 1;">Save Changes</button>
          <button type="button" class="btn-secondary" onclick="closeEditReadingModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Full Log Modal -->
  <div class="full-log-modal" id="fullLogModal">
    <div class="full-log-header">
      <div class="full-log-header-inner">
        <h2>Reading History</h2>
        <button class="full-log-close" onclick="closeFullLog()">✕</button>
      </div>
    </div>
    <div class="full-log-content">
      <div class="full-log-filters">
        <select id="fullLogTagFilter">
          <option value="all">All Tags</option>
        </select>
        <input type="month" id="fullLogMonthFilter">
      </div>
      <div id="fullLogReadings"></div>
    </div>
  </div>

  <!-- Sync Modal -->
  <div class="modal" id="syncModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Cloud Sync</h2>
        <p>Keep your data synchronized across all devices</p>
      </div>
      <div class="sync-status" id="syncStatus"></div>
      <div class="sync-actions">
        <button class="btn-primary" onclick="syncNow()">Sync Now</button>
        <button class="btn-secondary" onclick="closeSyncModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Verse of the Day Modal -->
  <div class="verse-modal" id="verseModal">
    <div class="verse-modal-content">
      <div class="verse-modal-header">
        <h2>Verse of the Day</h2>
      </div>
      <div class="verse-modal-verse-box">
        <div class="verse-modal-text" id="verseModalText"></div>
        <div class="verse-modal-ref" id="verseModalRef"></div>
      </div>
      <button class="verse-modal-btn" onclick="closeVerseModal()">Amen</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // Tag colors for chart - peaceful palette
    const TAG_COLORS = {
      'morning-fasting': '#7c9885',
      'post-breakfast1': '#a8c5b0',
      'post-breakfast2': '#8fa89a',
      'pre-lunch': '#5d7a66',
      'post-lunch1': '#d4a574',
      'post-lunch2': '#c49470',
      'pre-dinner': '#b8846c',
      'post-dinner1': '#9e9e9e',
      'post-dinner2': '#808080',
    };

    // Tag display names
    const TAG_NAMES = {
      'morning-fasting': 'Morning Fasting',
      'post-breakfast1': 'Post-Breakfast (1hr)',
      'post-breakfast2': 'Post-Breakfast (2hr)',
      'pre-lunch': 'Pre-Lunch',
      'post-lunch1': 'Post-Lunch (1hr)',
      'post-lunch2': 'Post-Lunch (2hr)',
      'pre-dinner': 'Pre-Dinner',
      'post-dinner1': 'Post-Dinner (1hr)',
      'post-dinner2': 'Post-Dinner (2hr)'
    };

    // Blood sugar ranges by profile
    const RANGES = {
      male: {
        'morning-fasting': { low: 80, high: 100, warning: 125 },
        'post-breakfast1': { low: 80, high: 130 },
        'post-breakfast2': { low: 80, high: 180 },
        'pre-lunch': { low: 80, high: 130 },
        'post-lunch1': { low: 80, high: 180 },
        'post-lunch2': { low: 80, high: 140 },
        'pre-dinner': { low: 80, high: 130 },
        'post-dinner1': { low: 80, high: 180 },
        'post-dinner2': { low: 80, high: 140 }
      },
      female: {
        'morning-fasting': { low: 80, high: 100, warning: 125 },
        'post-breakfast1': { low: 80, high: 130 },
        'post-breakfast2': { low: 80, high: 180 },
        'pre-lunch': { low: 80, high: 130 },
        'post-lunch1': { low: 80, high: 180 },
        'post-lunch2': { low: 80, high: 140 },
        'pre-dinner': { low: 80, high: 130 },
        'post-dinner1': { low: 80, high: 180 },
        'post-dinner2': { low: 80, high: 140 }
      },
      pregnant: {
        'morning-fasting': { low: 70, high: 95 },
        'post-breakfast1': { low: 80, high: 140 },
        'post-breakfast2': { low: 80, high: 120 },
        'pre-lunch': { low: 70, high: 100 },
        'post-lunch1': { low: 80, high: 140 },
        'post-lunch2': { low: 80, high: 120 },
        'pre-dinner': { low: 70, high: 100 },
        'post-dinner1': { low: 80, high: 140 },
        'post-dinner2': { low: 70, high: 120 }
      }
    };

    // ESV Bible verses focused on hope and endurance
    const VERSES = [
      { text: "But they who wait for the Lord shall renew their strength; they shall mount up with wings like eagles; they shall run and not be weary; they shall walk and not faint.", ref: "Isaiah 40:31" },
      { text: "Count it all joy, my brothers, when you meet trials of various kinds, for you know that the testing of your faith produces steadfastness.", ref: "James 1:2-3" },
      { text: "For I consider that the sufferings of this present time are not worth comparing with the glory that is to be revealed to us.", ref: "Romans 8:18" },
      { text: "Not only that, but we rejoice in our sufferings, knowing that suffering produces endurance, and endurance produces character, and character produces hope.", ref: "Romans 5:3-4" },
      { text: "May the God of hope fill you with all joy and peace in believing, so that by the power of the Holy Spirit you may abound in hope.", ref: "Romans 15:13" },
      { text: "Therefore we do not lose heart. Though our outer self is wasting away, our inner self is being renewed day by day.", ref: "2 Corinthians 4:16" },
      { text: "I can do all things through him who strengthens me.", ref: "Philippians 4:13" },
      { text: "The Lord is my strength and my shield; in him my heart trusts, and I am helped.", ref: "Psalm 28:7" },
      { text: "Be strong and courageous. Do not fear or be in dread of them, for it is the Lord your God who goes with you. He will not leave you or forsake you.", ref: "Deuteronomy 31:6" },
      { text: "Cast your burden on the Lord, and he will sustain you; he will never permit the righteous to be moved.", ref: "Psalm 55:22" },
      { text: "The Lord is near to the brokenhearted and saves the crushed in spirit.", ref: "Psalm 34:18" },
      { text: "And we know that for those who love God all things work together for good, for those who are called according to his purpose.", ref: "Romans 8:28" },
      { text: "Fear not, for I am with you; be not dismayed, for I am your God; I will strengthen you, I will help you, I will uphold you with my righteous right hand.", ref: "Isaiah 41:10" },
      { text: "Blessed is the man who remains steadfast under trial, for when he has stood the test he will receive the crown of life.", ref: "James 1:12" },
      { text: "For this light momentary affliction is preparing for us an eternal weight of glory beyond all comparison.", ref: "2 Corinthians 4:17" }
    ];

    // State
    let appData = {
      profile: null,
      readings: [],
      customTags: [],
      customRanges: {}
    };
    let chart = null;
    let currentTimeRange = 7;
    let hiddenTags = new Set();
    let selectedProfile = null;
    let chartView = 'all'; // 'all', 'date', 'tag'
    let selectedDate = null;
    let selectedTag = null;
    let recentReadingsFilter = 'all'; // filter by tag for recent readings
    let highlightedReadingId = null; // track clicked reading to always show it

    // Google Drive
    let accessToken = null;
    let tokenClient = null;

    // Initialize
    function init() {
      initTheme();
      loadData();
      loadChartState();
      setupEventListeners();
      setCurrentDateTime();
      displayVerse();
      
      if (!appData.profile) {
        showProfileModal();
      } else {
        updateUI();
        checkAndShowVerseModal();
      }

      initGoogleAPI();
      
      // Refresh timestamp when app resumes from background (fixes iOS issue)
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          setCurrentDateTime();
          // Check if day changed while app was backgrounded - refresh verse if needed
          const today = new Date().toDateString();
          const savedVerseDate = localStorage.getItem('blood-sugar-verse-date');
          if (savedVerseDate !== today) {
            displayVerse();
            checkAndShowVerseModal();
          }
        }
      });
      
      // Also handle iOS-specific page show event (back/forward cache)
      window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
          setCurrentDateTime();
          displayVerse();
        }
      });
    }

    // Theme
    function initTheme() {
      const saved = localStorage.getItem('blood-sugar-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
      updateThemeIcon(theme);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('blood-sugar-theme', next);
      updateThemeIcon(next);
      updateChartColors();
    }

    function updateChartColors() {
      Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#5d7a66';
      if (typeof updateChart === 'function') updateChart();
    }

    function updateThemeIcon(theme) {
      document.getElementById('themeToggle').textContent = theme === 'dark' ? '☼' : '☽';
    }

    // Data Management
    function loadData() {
      try {
        const saved = localStorage.getItem('blood-sugar-data');
        if (saved) {
          appData = JSON.parse(saved);
          if (!appData.customTags) appData.customTags = [];
          if (!appData.customRanges) appData.customRanges = {};
        }
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function saveData() {
      try {
        // Keep readings sorted by timestamp
        appData.readings.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        localStorage.setItem('blood-sugar-data', JSON.stringify(appData));
        localStorage.setItem('blood-sugar-timestamp', new Date().toISOString());
      } catch (error) {
        console.error('Error saving data:', error);
      }
    }

    function saveChartState() {
      try {
        const state = {
          currentTimeRange,
          hiddenTags: Array.from(hiddenTags),
          selectedTag,
          chartView
        };
        localStorage.setItem('blood-sugar-chart-state', JSON.stringify(state));
      } catch (error) {
        console.error('Error saving chart state:', error);
      }
    }

    function loadChartState() {
      try {
        const saved = localStorage.getItem('blood-sugar-chart-state');
        if (saved) {
          const state = JSON.parse(saved);
          currentTimeRange = state.currentTimeRange || 7;
          hiddenTags = new Set(state.hiddenTags || []);
          selectedTag = state.selectedTag || null;
          chartView = state.chartView || 'all';
        }
      } catch (error) {
        console.error('Error loading chart state:', error);
      }
    }

    function syncChartStateUI() {
      // Set range buttons
      document.querySelectorAll('.range-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.days) === currentTimeRange);
      });
      
      // Set view buttons
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === chartView);
      });
    }

    // Profile Management
    function showProfileModal() {
      document.getElementById('profileModal').classList.add('show');
    }

    function hideProfileModal() {
      document.getElementById('profileModal').classList.remove('show');
    }

    function changeProfile() {
      closeSettingsModal();
      showProfileModal();
    }

    // Verse Display
    function displayVerse() {
      const today = new Date().toDateString();
      const savedVerse = localStorage.getItem('blood-sugar-verse-date');
      let verse;

      if (savedVerse === today) {
        const savedVerseData = localStorage.getItem('blood-sugar-verse-data');
        if (savedVerseData) {
          verse = JSON.parse(savedVerseData);
        }
      }

      if (!verse) {
        const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
        verse = VERSES[dayOfYear % VERSES.length];
        localStorage.setItem('blood-sugar-verse-date', today);
        localStorage.setItem('blood-sugar-verse-data', JSON.stringify(verse));
      }

      document.getElementById('verseText').textContent = verse.text;
      document.getElementById('verseRef').textContent = verse.ref;
    }

    // Verse of the Day Modal
    function checkAndShowVerseModal() {
      const today = new Date().toDateString();
      const lastShownDate = localStorage.getItem('blood-sugar-verse-modal-date');
      
      // Only show if we haven't shown it today
      if (lastShownDate !== today) {
        const verseText = document.getElementById('verseText').textContent;
        const verseRef = document.getElementById('verseRef').textContent;
        
        document.getElementById('verseModalText').textContent = verseText;
        document.getElementById('verseModalRef').textContent = verseRef;
        document.getElementById('verseModal').classList.add('show');
      }
    }

    function closeVerseModal() {
      document.getElementById('verseModal').classList.remove('show');
      // Save that we've shown the modal today
      localStorage.setItem('blood-sugar-verse-modal-date', new Date().toDateString());
    }

    // Date/Time
    function setCurrentDateTime() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('timestamp').value = `${year}-${month}-${day}T${hours}:${minutes}`;
      
      const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      document.getElementById('dateDisplay').textContent = dateStr;
    }

    // Entry Form
    function showEntryForm() {
      document.getElementById('entryForm').classList.remove('hidden');
      document.getElementById('entryForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
      updateTagDropdown();
    }

    function hideEntryForm() {
      document.getElementById('entryForm').classList.add('hidden');
      document.getElementById('readingForm').reset();
      document.getElementById('customTagForm').classList.add('hidden');
      setCurrentDateTime();
    }

    function handleTagChange() {
      const tag = document.getElementById('tag').value;
      const customForm = document.getElementById('customTagForm');
      
      if (tag === 'custom') {
        customForm.classList.remove('hidden');
      } else {
        customForm.classList.add('hidden');
      }
      
      updateRangeIndicator();
    }

    function updateRangeIndicator() {
      const tag = document.getElementById('tag').value;
      const reading = parseFloat(document.getElementById('reading').value);
      const indicator = document.getElementById('rangeIndicator');

      if (!tag || !reading || tag === 'custom') {
        indicator.textContent = '';
        indicator.className = 'range-indicator';
        return;
      }

      if (!appData.profile || !RANGES[appData.profile]) return;
      const range = RANGES[appData.profile][tag];
      if (!range) return;

      indicator.textContent = `Target: ${range.low}-${range.high} mg/dL`;
      
      if (reading >= range.low && reading <= range.high) {
        indicator.className = 'range-indicator in-range';
        indicator.textContent += ' ✓ In Range';
      } else if (range.warning && reading > range.high && reading <= range.warning) {
        indicator.className = 'range-indicator warning';
        indicator.textContent += ' ⚠ Elevated';
      } else {
        indicator.className = 'range-indicator danger';
        indicator.textContent += ' ⚠ Out of Range';
      }
    }

    function getTagsUsedOnDate(date) {
      const targetDate = new Date(date);
      targetDate.setHours(0, 0, 0, 0);
      return new Set(appData.readings.filter(r => {
        const readingDate = new Date(r.timestamp);
        readingDate.setHours(0, 0, 0, 0);
        return readingDate.getTime() === targetDate.getTime();
      }).map(r => r.tag));
    }

    function updateTagDropdown() {
      const timestamp = document.getElementById('timestamp').value;
      const tagSelect = document.getElementById('tag');
      const usedTags = getTagsUsedOnDate(timestamp);
      
      const customOption = tagSelect.querySelector('option[value="custom"]');
      if (customOption) {
        customOption.remove();
      }
      tagSelect.querySelectorAll('option[data-custom="true"]').forEach(opt => opt.remove());
      
      Array.from(tagSelect.options).forEach(option => {
        if (option.value && option.value !== 'custom') {
          option.disabled = usedTags.has(option.value);
          if (usedTags.has(option.value)) {
            option.textContent = TAG_NAMES[option.value] + ' (already logged)';
          } else {
            option.textContent = TAG_NAMES[option.value] || option.value;
          }
        }
      });

      appData.customTags.forEach(ct => {
        const option = document.createElement('option');
        option.value = ct.id;
        option.dataset.custom = 'true';
        option.disabled = usedTags.has(ct.id);
        option.textContent = usedTags.has(ct.id) ? ct.name + ' (already logged)' : ct.name;
        tagSelect.appendChild(option);
      });

      const newCustomOption = document.createElement('option');
      newCustomOption.value = 'custom';
      newCustomOption.textContent = '+ Add Custom Tag';
      tagSelect.appendChild(newCustomOption);

      if (usedTags.has(tagSelect.value)) {
        tagSelect.value = '';
      }
    }

    function submitReading(e) {
      e.preventDefault();
      
      let tag = document.getElementById('tag').value;
      const timestamp = document.getElementById('timestamp').value;
      const reading = parseFloat(document.getElementById('reading').value);
      const notes = document.getElementById('notes').value;

      const usedTags = getTagsUsedOnDate(timestamp);
      if (tag !== 'custom' && usedTags.has(tag)) {
        alert('This tag has already been used today. Please choose a different tag.');
        return;
      }

      if (tag === 'custom') {
        const customName = document.getElementById('customTagName').value.trim();
        const customLow = parseFloat(document.getElementById('customLow').value);
        const customHigh = parseFloat(document.getElementById('customHigh').value);

        if (!customName) {
          alert('Please enter a name for your custom tag');
          return;
        }

        tag = 'custom-' + customName.toLowerCase().replace(/\s+/g, '-');
        
        const existingTag = appData.customTags.find(t => t.id === tag);
        if (!existingTag) {
          appData.customTags.push({
            id: tag,
            name: customName,
            range: { low: customLow, high: customHigh }
          });
          TAG_NAMES[tag] = customName;
          TAG_COLORS[tag] = '#9E9E9E';
        }
      }

      const newReading = {
        id: Date.now().toString(),
        timestamp: new Date(timestamp).toISOString(),
        tag,
        reading,
        notes
      };

      appData.readings.push(newReading);
      saveData();
      updateUI();
      hideEntryForm();
    }

    // UI Updates
    function updateUI() {
      syncChartStateUI();
      updateTodayWidget();
      updateInsights();
      updateChart();
      updateRecentReadingsFilter();
      updateRecentReadings();
    }

    function updateTodayWidget() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayReadings = appData.readings.filter(r => {
        const readingDate = new Date(r.timestamp);
        readingDate.setHours(0, 0, 0, 0);
        return readingDate.getTime() === today.getTime();
      });

      document.getElementById('statusText').textContent = 
        `${todayReadings.length} reading${todayReadings.length !== 1 ? 's' : ''} logged today`;

      const usedTags = new Set(appData.readings.map(r => r.tag));
      const indicators = document.getElementById('tagIndicators');
      indicators.innerHTML = '';

      const todayTags = new Set(todayReadings.map(r => r.tag));

      usedTags.forEach(tag => {
        const tagName = TAG_NAMES[tag] || appData.customTags.find(t => t.id === tag)?.name || tag;
        const isLogged = todayTags.has(tag);
        const indicator = document.createElement('div');
        indicator.className = 'tag-indicator' + (isLogged ? ' logged' : '');
        indicator.innerHTML = `
          <span class="tag-dot"></span>
          <span>${tagName}</span>
        `;
        if (!isLogged) {
          indicator.addEventListener('click', () => quickAddReading(tag));
          indicator.title = 'Click to add reading';
        } else {
          indicator.title = 'Already logged today';
        }
        indicators.appendChild(indicator);
      });
    }

    function quickAddReading(tag) {
      setCurrentDateTime();
      document.getElementById('entryForm').classList.remove('hidden');
      updateTagDropdown();
      document.getElementById('tag').value = tag;
      updateRangeIndicator();
      document.getElementById('entryForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
      document.getElementById('reading').focus();
    }

    function updateInsights() {
      const days = currentTimeRange;
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      
      const recentReadings = appData.readings.filter(r => new Date(r.timestamp) >= cutoff);

      if (recentReadings.length === 0) {
        document.getElementById('timeInRange').textContent = '--';
        document.getElementById('avgReading').textContent = '--';
        document.getElementById('highReading').textContent = '--';
        document.getElementById('lowReading').textContent = '--';
        return;
      }

      let inRangeCount = 0;
      let total = 0;
      let sum = 0;
      let high = -Infinity;
      let low = Infinity;

      recentReadings.forEach(r => {
        const range = getRange(r.tag);
        if (range && r.reading >= range.low && r.reading <= range.high) {
          inRangeCount++;
        }
        total++;
        sum += r.reading;
        if (r.reading > high) high = r.reading;
        if (r.reading < low) low = r.reading;
      });

      const timeInRange = Math.round((inRangeCount / total) * 100);
      const avg = Math.round(sum / total);

      document.getElementById('timeInRange').textContent = timeInRange + '%';
      document.getElementById('avgReading').textContent = avg;
      document.getElementById('highReading').textContent = high === -Infinity ? '--' : high;
      document.getElementById('lowReading').textContent = low === Infinity ? '--' : low;
    }

    function updateChartFilters() {
      const dateFilter = document.getElementById('dateFilter');
      const tagFilter = document.getElementById('tagFilter');
      const filtersRow = document.getElementById('chartFilters');
      const timeRangeSelector = document.getElementById('timeRangeSelector');

      const dates = [...new Set(appData.readings.map(r => {
        const d = new Date(r.timestamp);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      }))].sort().reverse();
      const tags = [...new Set(appData.readings.map(r => r.tag))];

      dateFilter.innerHTML = dates.map(d => {
        const localDate = new Date(`${d}T00:00:00`);
        return `<option value="${d}">${localDate.toLocaleDateString()}</option>`;
      }).join('');
      tagFilter.innerHTML = tags.map(t => `<option value="${t}">${TAG_NAMES[t] || appData.customTags.find(ct => ct.id === t)?.name || t}</option>`).join('');

      if (!selectedDate && dates.length) selectedDate = dates[0];
      if (!selectedTag && tags.length) selectedTag = tags[0];

      dateFilter.value = selectedDate || '';
      tagFilter.value = selectedTag || '';

      if (chartView === 'all') {
        filtersRow.style.display = 'none';
        timeRangeSelector.style.display = 'flex';
      } else if (chartView === 'date') {
        filtersRow.style.display = 'flex';
        dateFilter.style.display = 'block';
        tagFilter.style.display = 'none';
        timeRangeSelector.style.display = 'none';
      } else if (chartView === 'tag') {
        filtersRow.style.display = 'flex';
        dateFilter.style.display = 'none';
        tagFilter.style.display = 'block';
        timeRangeSelector.style.display = 'flex';
      }
    }

    Chart.defaults.font.family = "'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif";
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#5d7a66';

    function updateChart() {
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');

      updateChartFilters();

      if (chartView === 'all') {
        renderAllTagsChart(canvas, ctx);
      } else if (chartView === 'date') {
        renderSingleDateChart(canvas, ctx);
      } else if (chartView === 'tag') {
        renderSingleTagChart(canvas, ctx);
      }
    }

    function renderAllTagsChart(canvas, ctx) {
      const days = currentTimeRange;
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);

      const recentReadings = appData.readings.filter(r => new Date(r.timestamp) >= cutoff);

      if (recentReadings.length === 0) {
        renderEmptyChart(canvas, ctx);
        return;
      }

      const allTags = [...new Set(recentReadings.map(r => r.tag))];
      const usedTags = allTags.filter(t => !hiddenTags.has(t));
      
      const datasets = usedTags.map(tag => {
        const tagReadings = recentReadings.filter(r => r.tag === tag);
        const data = tagReadings.map(r => ({
          x: new Date(r.timestamp),
          y: r.reading,
          notes: r.notes,
          readingId: r.id
        })).sort((a, b) => a.x - b.x);

        const color = TAG_COLORS[tag] || '#9E9E9E';

        return {
          label: TAG_NAMES[tag] || appData.customTags.find(t => t.id === tag)?.name || tag,
          data: data,
          borderColor: color,
          backgroundColor: color,
          pointRadius: 4,
          pointHoverRadius: 6,
          tension: 0.3
        };
      });

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => new Date(items[0].parsed.x).toLocaleString(),
                label: (item) => {
                  let label = `${item.dataset.label}: ${item.parsed.y} mg/dL`;
                  if (item.raw.notes) label += ` - ${item.raw.notes}`;
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: days <= 7 ? 'day' : days <= 30 ? 'week' : 'month' },
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') }
            },
            y: {
              beginAtZero: false,
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { callback: (value) => value + ' mg/dL' }
            }
          },
          onClick: handleChartClick
        }
      });

      updateChartLegend(allTags);
    }

    function handleChartClick(event, elements) {
      if (elements.length === 0) return;
      
      const element = elements[0];
      const dataPoint = chart.data.datasets[element.datasetIndex].data[element.index];
      
      if (dataPoint && dataPoint.readingId) {
        scrollToReading(dataPoint.readingId);
      }
    }

    function scrollToReading(readingId) {
      highlightedReadingId = readingId;
      updateRecentReadings(); // Re-render to include highlighted reading if filtered
      const readingElement = document.querySelector(`[data-reading-id="${readingId}"]`);
      if (readingElement) {
        readingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        readingElement.classList.add('highlight');
        setTimeout(() => {
          readingElement.classList.remove('highlight');
          highlightedReadingId = null;
        }, 2000);
      }
    }

    function renderSingleDateChart(canvas, ctx) {
      if (!selectedDate) {
        renderEmptyChart(canvas, ctx);
        return;
      }

      const dayStart = new Date(`${selectedDate}T00:00:00`);
      const dayEnd = new Date(dayStart);
      dayEnd.setDate(dayEnd.getDate() + 1);

      const dayReadings = appData.readings.filter(r => {
        const d = new Date(r.timestamp);
        return d >= dayStart && d < dayEnd;
      });

      if (dayReadings.length === 0) {
        renderEmptyChart(canvas, ctx);
        return;
      }

      const datasets = [];
      const rangeAnnotations = [];

      const data = dayReadings.map(r => {
        const range = getRange(r.tag);
        return {
          x: new Date(r.timestamp),
          y: r.reading,
          notes: r.notes,
          tag: r.tag,
          low: range?.low,
          high: range?.high,
          readingId: r.id
        };
      }).sort((a, b) => a.x - b.x);

      const color = getComputedStyle(document.documentElement).getPropertyValue('--primary');
      datasets.push({
        label: 'Readings',
        data: data,
        borderColor: color,
        backgroundColor: color,
        pointRadius: 6,
        pointHoverRadius: 8,
        tension: 0.3
      });

      const dataWithRanges = data.filter(d => d.low != null && d.high != null);
      
      if (dataWithRanges.length > 0) {
        datasets.push({
          label: 'Lower Bound',
          data: dataWithRanges.map(d => ({ x: d.x, y: d.low })),
          borderColor: 'rgba(124, 152, 133, 0.4)',
          backgroundColor: 'rgba(124, 152, 133, 0.3)',
          borderDash: [5, 5],
          pointRadius: 3,
          pointHoverRadius: 5,
          tension: 0.3,
          fill: {
            target: '+1',
            above: 'rgba(124, 152, 133, 0.15)',
            below: 'rgba(124, 152, 133, 0.15)'
          }
        });
        datasets.push({
          label: 'Upper Bound',
          data: dataWithRanges.map(d => ({ x: d.x, y: d.high })),
          borderColor: 'rgba(124, 152, 133, 0.4)',
          backgroundColor: 'rgba(124, 152, 133, 0.3)',
          borderDash: [5, 5],
          pointRadius: 3,
          pointHoverRadius: 5,
          tension: 0.3,
          fill: false
        });
      }

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            filler: { propagate: false },
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => new Date(items[0].parsed.x).toLocaleTimeString(),
                label: (item) => {
                  if (item.datasetIndex === 0) {
                    const d = item.raw;
                    const tagName = TAG_NAMES[d.tag] || appData.customTags.find(t => t.id === d.tag)?.name || d.tag;
                    let label = `${tagName}: ${item.parsed.y} mg/dL`;
                    if (d.notes) label += ` - ${d.notes}`;
                    if (d.low && d.high) label += ` (range: ${d.low}-${d.high})`;
                    return label;
                  }
                  return `${item.dataset.label}: ${item.parsed.y} mg/dL`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: { hour: 'h:mm a' }
              },
              ticks: {
                maxTicksLimit: 8,
                autoSkip: false,
                callback: function(value, index, values) {
                  if (values.length <= 1) return value;
                  if (index === 0 || index === values.length - 1) return value;
                  const step = Math.ceil(values.length / 5);
                  if (index % step === 0) return value;
                  return null;
                }
              },
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              min: dayStart,
              max: dayEnd
            },
            y: {
              beginAtZero: false,
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { callback: (value) => value + ' mg/dL' }
            }
          },
          onClick: handleChartClick
        }
      });

      document.getElementById('chartLegend').innerHTML = '';
    }

    function renderSingleTagChart(canvas, ctx) {
      if (!selectedTag) {
        renderEmptyChart(canvas, ctx);
        return;
      }

      const days = currentTimeRange;
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);

      const tagReadings = appData.readings.filter(r => r.tag === selectedTag && new Date(r.timestamp) >= cutoff);

      if (tagReadings.length === 0) {
        renderEmptyChart(canvas, ctx);
        return;
      }

      const range = getRange(selectedTag);
      console.log('Single tag chart debug:', { profile: appData.profile, selectedTag, range });
      const color = TAG_COLORS[selectedTag] || '#9E9E9E';

      const data = tagReadings.map(r => ({
        x: new Date(r.timestamp),
        y: r.reading,
        notes: r.notes,
        readingId: r.id
      })).sort((a, b) => a.x - b.x);

      const datasets = [{
        label: TAG_NAMES[selectedTag] || appData.customTags.find(t => t.id === selectedTag)?.name || selectedTag,
        data: data,
        borderColor: color,
        backgroundColor: color,
        pointRadius: 5,
        pointHoverRadius: 7,
        tension: 0.3
      }];

      if (range) {
        datasets.push({
          label: 'Target Range',
          data: data.map(d => ({ x: d.x, y: range.low })),
          borderColor: 'rgba(124, 152, 133, 0.5)',
          backgroundColor: 'rgba(124, 152, 133, 0.3)',
          borderDash: [5, 5],
          pointRadius: 3,
          pointHoverRadius: 5,
          tension: 0.3,
          fill: {
            target: '+1',
            above: 'rgba(124, 152, 133, 0.15)',
            below: 'rgba(124, 152, 133, 0.15)'
          }
        });
        datasets.push({
          label: 'Upper Bound',
          data: data.map(d => ({ x: d.x, y: range.high })),
          borderColor: 'rgba(124, 152, 133, 0.5)',
          backgroundColor: 'rgba(124, 152, 133, 0.3)',
          borderDash: [5, 5],
          pointRadius: 3,
          pointHoverRadius: 5,
          tension: 0.3,
          fill: false
        });
      }

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            filler: { propagate: false },
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => new Date(items[0].parsed.x).toLocaleString(),
                label: (item) => {
                  let label = `${item.dataset.label}: ${item.parsed.y} mg/dL`;
                  if (item.datasetIndex === 0 && item.raw.notes) label += ` - ${item.raw.notes}`;
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: days <= 7 ? 'day' : days <= 30 ? 'week' : 'month' },
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') }
            },
            y: {
              beginAtZero: false,
              grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-color') },
              ticks: { callback: (value) => value + ' mg/dL' }
            }
          },
          onClick: handleChartClick
        }
      });

      document.getElementById('chartLegend').innerHTML = '';
    }

    function renderEmptyChart(canvas, ctx) {
      if (chart) {
        chart.destroy();
        chart = null;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
      ctx.font = '16px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('No data to display', canvas.width / 2, canvas.height / 2);
      document.getElementById('chartLegend').innerHTML = '';
    }

    function updateChartLegend(allTags) {
      const legend = document.getElementById('chartLegend');
      legend.innerHTML = '';

      allTags.forEach(tag => {
        const color = TAG_COLORS[tag] || '#9E9E9E';
        const name = TAG_NAMES[tag] || appData.customTags.find(t => t.id === tag)?.name || tag;
        const isHidden = hiddenTags.has(tag);

        const item = document.createElement('div');
        item.className = 'legend-item' + (isHidden ? ' disabled' : '');
        item.innerHTML = `
          <input type="checkbox" class="legend-checkbox" ${isHidden ? '' : 'checked'} data-tag="${tag}">
          <span class="legend-color" style="background: ${color}"></span>
          <span class="legend-label">${name}</span>
        `;
        item.addEventListener('click', (e) => {
          if (e.target.classList.contains('legend-checkbox')) return;
          const checkbox = item.querySelector('.legend-checkbox');
          checkbox.checked = !checkbox.checked;
          toggleTag(tag);
        });
        legend.appendChild(item);
      });

      if (hiddenTags.size > 0) {
        const resetLink = document.createElement('span');
        resetLink.className = 'legend-reset';
        resetLink.textContent = 'Show All';
        resetLink.addEventListener('click', () => {
          hiddenTags.clear();
          updateChart();
        });
        legend.appendChild(resetLink);
      }
    }

    function toggleTag(tag) {
      if (hiddenTags.has(tag)) {
        hiddenTags.delete(tag);
      } else {
        hiddenTags.add(tag);
      }
      saveChartState();
      updateChart();
    }

    function updateRecentReadingsFilter() {
      const filterSelect = document.getElementById('recentTagFilter');
      const usedTags = [...new Set(appData.readings.map(r => r.tag))].sort();
      
      // Preserve current selection
      const currentValue = filterSelect.value;
      
      // Clear existing options except "All Tags"
      filterSelect.innerHTML = '<option value="all">All Tags</option>';
      
      // Add options for each tag
      usedTags.forEach(tag => {
        const tagName = TAG_NAMES[tag] || appData.customTags.find(t => t.id === tag)?.name || tag;
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tagName;
        filterSelect.appendChild(option);
      });
      
      // Restore previous selection if it still exists
      if ([...filterSelect.options].some(o => o.value === currentValue)) {
        filterSelect.value = currentValue;
      }
    }

    function updateRecentReadings() {
      const container = document.getElementById('recentReadings');
      let recent = [...appData.readings].sort((a, b) =>
        new Date(b.timestamp) - new Date(a.timestamp)
      ).slice(0, 10);

      // Filter by tag if filter is set
      if (recentReadingsFilter !== 'all') {
        recent = recent.filter(r => r.tag === recentReadingsFilter);
        // Always include highlighted reading even if filtered out
        if (highlightedReadingId) {
          const highlightedReading = appData.readings.find(r => r.id === highlightedReadingId);
          if (highlightedReading && !recent.find(r => r.id === highlightedReadingId)) {
            recent.unshift(highlightedReading);
          }
        }
      }

      const viewAllBtn = document.getElementById('viewAllBtn');
      
      if (appData.readings.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📊</div>
            <div class="empty-state-text">No readings yet</div>
            <div class="empty-state-subtext">Click "Add Reading" to get started</div>
          </div>
        `;
        viewAllBtn.style.display = 'none';
        return;
      }
      
      viewAllBtn.style.display = appData.readings.length > 10 ? 'block' : 'none';
      
      if (recent.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">🔍</div>
            <div class="empty-state-text">No matching readings</div>
            <div class="empty-state-subtext">Try a different filter</div>
          </div>
        `;
        return;
      }

      container.innerHTML = recent.map(r => {
        const date = new Date(r.timestamp);
        const timeStr = date.toLocaleString('en-US', {
          month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
        });
        const tagName = TAG_NAMES[r.tag] || appData.customTags.find(t => t.id === r.tag)?.name || r.tag;
        const range = getRange(r.tag);
        let statusClass = '';
        if (range) {
          if (r.reading >= range.low && r.reading <= range.high) {
            statusClass = 'in-range';
          } else if (range.warning && r.reading > range.high && r.reading <= range.warning) {
            statusClass = 'warning';
          } else {
            statusClass = 'danger';
          }
        }

        return `
          <div class="reading-item" data-reading-id="${r.id}" onclick="openEditReading('${r.id}')">
            <div class="reading-info">
              <div class="reading-header">
                <span class="reading-tag">${tagName}</span>
                <span class="reading-time">${timeStr}</span>
              </div>
              <div class="reading-value ${statusClass}">${r.reading} mg/dL</div>
              ${r.notes ? `<div class="reading-notes">${r.notes}</div>` : ''}
            </div>
            <button class="delete-btn" onclick="deleteReading('${r.id}', event)" aria-label="Delete"><svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6"/></svg></button>
          </div>
        `;
      }).join('');
    }

    function getRange(tag) {
      // Check user-customized ranges first
      if (appData.customRanges && appData.customRanges[tag]) {
        return appData.customRanges[tag];
      }
      // Then check custom tags
      if (tag.startsWith('custom-')) {
        const customTag = appData.customTags.find(t => t.id === tag);
        return customTag ? customTag.range : null;
      }
      // Fall back to profile defaults
      return RANGES[appData.profile]?.[tag];
    }

    function getDefaultRange(tag) {
      if (tag.startsWith('custom-')) {
        const customTag = appData.customTags.find(t => t.id === tag);
        return customTag ? customTag.range : { low: 70, high: 140 };
      }
      return RANGES[appData.profile]?.[tag] || { low: 70, high: 140 };
    }

    function saveCustomRange(tag, low, high) {
      appData.customRanges[tag] = { low: parseFloat(low), high: parseFloat(high) };
      saveData();
      updateUI();
    }

    function resetRangeToDefault(tag) {
      delete appData.customRanges[tag];
      saveData();
      showSettingsModal(); // Refresh the settings UI
      updateUI();
    }

    function deleteReading(id, event) {
      if (event) event.stopPropagation();
      if (confirm('Delete this reading?')) {
        appData.readings = appData.readings.filter(r => r.id !== id);
        saveData();
        updateUI();
        updateFullLogIfOpen();
      }
    }

    function openEditReading(id) {
      const reading = appData.readings.find(r => r.id === id);
      if (!reading) return;

      document.getElementById('editReadingId').value = reading.id;
      
      const date = new Date(reading.timestamp);
      const localTimestamp = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
        .toISOString().slice(0, 16);
      document.getElementById('editTimestamp').value = localTimestamp;
      
      const tagSelect = document.getElementById('editTag');
      tagSelect.innerHTML = '';
      
      Object.entries(TAG_NAMES).forEach(([value, name]) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = name;
        tagSelect.appendChild(option);
      });
      
      appData.customTags.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.name;
        tagSelect.appendChild(option);
      });
      
      tagSelect.value = reading.tag;
      document.getElementById('editReading').value = reading.reading;
      document.getElementById('editNotes').value = reading.notes || '';
      
      document.getElementById('editReadingModal').classList.add('show');
    }

    function closeEditReadingModal() {
      document.getElementById('editReadingModal').classList.remove('show');
    }

    function submitEditReading(e) {
      e.preventDefault();
      
      const id = document.getElementById('editReadingId').value;
      const reading = appData.readings.find(r => r.id === id);
      if (!reading) return;

      reading.timestamp = new Date(document.getElementById('editTimestamp').value).toISOString();
      reading.tag = document.getElementById('editTag').value;
      reading.reading = parseFloat(document.getElementById('editReading').value);
      reading.notes = document.getElementById('editNotes').value;

      saveData();
      updateUI();
      closeEditReadingModal();
      updateFullLogIfOpen();
    }

    function showFullLog() {
      populateFullLogFilters();
      updateFullLog();
      document.getElementById('fullLogModal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeFullLog() {
      document.getElementById('fullLogModal').classList.remove('show');
      document.body.style.overflow = '';
    }

    function populateFullLogFilters() {
      const tagSelect = document.getElementById('fullLogTagFilter');
      tagSelect.innerHTML = '<option value="all">All Tags</option>';
      
      const usedTags = [...new Set(appData.readings.map(r => r.tag))].sort();
      usedTags.forEach(tag => {
        const tagName = TAG_NAMES[tag] || appData.customTags.find(t => t.id === tag)?.name || tag;
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tagName;
        tagSelect.appendChild(option);
      });

      const monthInput = document.getElementById('fullLogMonthFilter');
      if (appData.readings.length > 0) {
        const dates = appData.readings.map(r => new Date(r.timestamp));
        const latestDate = new Date(Math.max(...dates));
        monthInput.value = latestDate.toISOString().slice(0, 7);
      } else {
        monthInput.value = new Date().toISOString().slice(0, 7);
      }
    }

    function updateFullLog() {
      const container = document.getElementById('fullLogReadings');
      const tagFilter = document.getElementById('fullLogTagFilter').value;
      const monthFilter = document.getElementById('fullLogMonthFilter').value;

      let filtered = [...appData.readings];
      
      if (tagFilter !== 'all') {
        filtered = filtered.filter(r => r.tag === tagFilter);
      }
      
      if (monthFilter) {
        filtered = filtered.filter(r => {
          const d = new Date(r.timestamp);
          const localMonth = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          return localMonth === monthFilter;
        });
      }

      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📊</div>
            <div class="empty-state-text">No readings found</div>
            <div class="empty-state-subtext">Try adjusting your filters</div>
          </div>
        `;
        return;
      }

      const grouped = {};
      filtered.forEach(r => {
        const d = new Date(r.timestamp);
        const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        if (!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push(r);
      });

      container.innerHTML = Object.entries(grouped).map(([date, readings]) => {
        const dateObj = new Date(date + 'T12:00:00');
        const dateStr = dateObj.toLocaleDateString('en-US', {
          weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
        });
        
        // Sort readings within each day by timestamp (newest first)
        readings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        return `
          <div class="log-date-group">
            <div class="log-date-header">${dateStr}</div>
            ${readings.map(r => {
              const time = new Date(r.timestamp).toLocaleTimeString('en-US', {
                hour: 'numeric', minute: '2-digit'
              });
              const tagName = TAG_NAMES[r.tag] || appData.customTags.find(t => t.id === r.tag)?.name || r.tag;
              const range = getRange(r.tag);
              let statusClass = '';
              if (range) {
                if (r.reading >= range.low && r.reading <= range.high) {
                  statusClass = 'in-range';
                } else if (range.warning && r.reading > range.high && r.reading <= range.warning) {
                  statusClass = 'warning';
                } else {
                  statusClass = 'danger';
                }
              }
              return `
                <div class="reading-item" data-reading-id="${r.id}" onclick="openEditReading('${r.id}')">
                  <div class="reading-info">
                    <div class="reading-header">
                      <span class="reading-tag">${tagName}</span>
                      <span class="reading-time">${time}</span>
                    </div>
                    <div class="reading-value ${statusClass}">${r.reading} mg/dL</div>
                    ${r.notes ? `<div class="reading-notes">${r.notes}</div>` : ''}
                  </div>
                  <button class="delete-btn" onclick="deleteReading('${r.id}', event)" aria-label="Delete"><svg viewBox="0 0 24 24"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6"/></svg></button>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).join('');
    }

    function updateFullLogIfOpen() {
      if (document.getElementById('fullLogModal').classList.contains('show')) {
        updateFullLog();
      }
    }

    // Settings
    function showSettingsModal() {
      const profileNames = { male: 'Male', female: 'Female (Non-pregnant)', pregnant: 'Pregnant Female' };
      document.getElementById('currentProfile').textContent = profileNames[appData.profile] || 'Not set';
      
      const customTagsList = document.getElementById('customTagsList');
      if (appData.customTags.length === 0) {
        customTagsList.innerHTML = '<p class="setting-description">No custom tags yet</p>';
      } else {
        customTagsList.innerHTML = appData.customTags.map(t => `
          <div style="padding: 8px; background: var(--bg-secondary); border-radius: 6px; margin-top: 8px;">
            <strong>${t.name}</strong>: ${t.range.low}-${t.range.high} mg/dL
          </div>
        `).join('');
      }

      // Render target ranges for all tags
      renderTargetRanges();
      
      document.getElementById('settingsModal').classList.add('show');
    }

    function renderTargetRanges() {
      const container = document.getElementById('targetRangesList');
      
      // Get all built-in tags
      const builtInTags = Object.keys(TAG_NAMES);
      
      // Get all custom tags
      const customTagIds = appData.customTags.map(t => t.id);
      
      // Combine all tags
      const allTags = [...builtInTags, ...customTagIds];
      
      container.innerHTML = allTags.map(tag => {
        const tagName = TAG_NAMES[tag] || appData.customTags.find(t => t.id === tag)?.name || tag;
        const currentRange = getRange(tag) || { low: 70, high: 140 };
        const defaultRange = getDefaultRange(tag);
        const isCustomized = appData.customRanges && appData.customRanges[tag];
        const isCustomTag = tag.startsWith('custom-');
        
        return `
          <div class="range-item" data-tag="${tag}">
            <div class="range-item-header">
              <span class="range-item-name">${tagName}</span>
              <div class="range-item-actions">
                ${isCustomized ? '<span class="range-item-badge">Custom</span>' : ''}
                <button class="range-btn range-btn-save" onclick="saveRangeFromInput('${tag}')">Save</button>
                ${isCustomized ? `<button class="range-btn range-btn-reset" onclick="resetRangeToDefault('${tag}')" title="Reset to ${defaultRange.low}-${defaultRange.high}">Reset</button>` : ''}
              </div>
            </div>
            <div class="range-item-inputs">
              <input type="number" id="range-low-${tag}" value="${currentRange.low}" min="0" max="500">
              <span>to</span>
              <input type="number" id="range-high-${tag}" value="${currentRange.high}" min="0" max="500">
              <span>mg/dL</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function saveRangeFromInput(tag) {
      const low = document.getElementById(`range-low-${tag}`).value;
      const high = document.getElementById(`range-high-${tag}`).value;
      
      if (parseFloat(low) >= parseFloat(high)) {
        alert('Low value must be less than high value');
        return;
      }
      
      saveCustomRange(tag, low, high);
      renderTargetRanges(); // Refresh to show badge
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    // Share functionality
    function getShareText() {
      const verseText = document.getElementById('verseText').textContent;
      const verseRef = document.getElementById('verseRef').textContent;
      return `I've been encouraged by this and thought you might appreciate it:\n\n"${verseText}"\n— ${verseRef}\n\nTrack your health journey with daily encouragement at:\nhttps://ctenold.github.io/BloodSugar`;
    }

    function openShareModal() {
      const shareText = getShareText();
      document.getElementById('sharePreviewText').textContent = shareText;
      document.getElementById('shareModal').classList.add('show');
      
      if (navigator.share) {
        document.getElementById('nativeShareOption').style.display = 'flex';
      }
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('show');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }

    function shareVia(method) {
      const shareText = getShareText();
      const encodedText = encodeURIComponent(shareText);
      
      switch (method) {
        case 'copy':
          navigator.clipboard.writeText(shareText).then(() => {
            showToast('Copied to clipboard!');
            closeShareModal();
          }).catch(() => {
            showToast('Could not copy to clipboard');
          });
          break;
          
        case 'native':
          if (navigator.share) {
            navigator.share({
              title: 'Daily Encouragement',
              text: shareText
            }).then(() => {
              closeShareModal();
            }).catch((err) => {
              if (err.name !== 'AbortError') {
                showToast('Could not share');
              }
            });
          }
          break;
          
        case 'sms':
          window.open(`sms:?body=${encodedText}`, '_blank');
          closeShareModal();
          break;
          
        case 'email':
          const subject = encodeURIComponent('A Verse to Encourage You');
          window.open(`mailto:?subject=${subject}&body=${encodedText}`, '_blank');
          closeShareModal();
          break;
          
        case 'whatsapp':
          window.open(`https://wa.me/?text=${encodedText}`, '_blank');
          closeShareModal();
          break;
          
        case 'twitter':
          window.open(`https://twitter.com/intent/tweet?text=${encodedText}`, '_blank');
          closeShareModal();
          break;
          
        case 'facebook':
          window.open(`https://www.facebook.com/sharer/sharer.php?quote=${encodedText}`, '_blank');
          closeShareModal();
          break;
      }
    }

    document.getElementById('shareBtn').addEventListener('click', openShareModal);

    document.getElementById('shareModal').addEventListener('click', (e) => {
      if (e.target.id === 'shareModal') {
        closeShareModal();
      }
    });

    // Verse modal click outside to close
    document.getElementById('verseModal').addEventListener('click', (e) => {
      if (e.target.id === 'verseModal') {
        closeVerseModal();
      }
    });

    // Data Export/Import
    function downloadDataJSON() {
      // Data is already sorted by saveData()
      const dataStr = JSON.stringify(appData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `glucose-journal-backup-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function downloadDataCSV() {
      if (!appData.readings || appData.readings.length === 0) {
        alert('No readings to export');
        return;
      }
      const headers = ['Date', 'Time', 'Reading (mg/dL)', 'Tag', 'Notes'];
      const rows = appData.readings
        .slice()
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
        .map(r => {
          const dt = new Date(r.timestamp);
          const date = dt.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
          const time = dt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
          const notes = (r.notes || '').replace(/"/g, '""');
          return `"${date}","${time}","${r.reading}","${r.tag}","${notes}"`;
        });
      const csvContent = [headers.join(','), ...rows].join('\n');
      const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `glucose-readings-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function uploadDataJSON(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.profile || !data.readings) {
            alert('Invalid data file. JSON must contain profile and readings.');
            return;
          }
          if (confirm('This will replace all current data including settings. Continue?')) {
            appData = data;
            if (!appData.customTags) appData.customTags = [];
            saveData(); // saveData() sorts readings
            updateUI();
            alert('Data imported successfully');
          }
        } catch (error) {
          alert('Error reading file: ' + error.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function uploadDataCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const lines = e.target.result.trim().split('\n');
          if (lines.length < 2) {
            alert('CSV file is empty or has no data rows');
            return;
          }
          
          const header = lines[0].toLowerCase();
          const hasHeader = header.includes('date') || header.includes('reading') || header.includes('time');
          const dataLines = hasHeader ? lines.slice(1) : lines;
          
          const newReadings = [];
          const errors = [];
          
          dataLines.forEach((line, idx) => {
            if (!line.trim()) return;
            
            const cols = parseCSVLine(line);
            if (cols.length < 3) {
              errors.push(`Row ${idx + 1}: Not enough columns`);
              return;
            }
            
            const dateStr = cols[0]?.trim();
            const timeStr = cols[1]?.trim();
            const readingStr = cols[2]?.trim();
            const tag = cols[3]?.trim() || 'other';
            const notes = cols[4]?.trim() || '';
            
            const reading = parseInt(readingStr, 10);
            if (isNaN(reading) || reading < 20 || reading > 600) {
              errors.push(`Row ${idx + 1}: Invalid reading value "${readingStr}"`);
              return;
            }
            
            const timestamp = parseDateTime(dateStr, timeStr);
            if (!timestamp) {
              errors.push(`Row ${idx + 1}: Could not parse date/time "${dateStr} ${timeStr}"`);
              return;
            }
            
            newReadings.push({
              id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
              timestamp: timestamp.toISOString(),
              reading: reading,
              tag: tag,
              notes: notes
            });
          });
          
          if (newReadings.length === 0) {
            alert('No valid readings found in CSV.\n\n' + errors.slice(0, 5).join('\n'));
            return;
          }
          
          const action = confirm(
            `Found ${newReadings.length} readings to import.\n\n` +
            (errors.length > 0 ? `${errors.length} rows had errors.\n\n` : '') +
            'Choose OK to ADD to existing readings, or Cancel to abort.\n\n' +
            '(To replace all data, use JSON import instead.)'
          );
          
          if (action) {
            appData.readings = [...appData.readings, ...newReadings];
            saveData();
            updateUI();
            alert(`Imported ${newReadings.length} readings successfully!`);
          }
        } catch (error) {
          alert('Error reading CSV: ' + error.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    function parseDateTime(dateStr, timeStr) {
      const combined = `${dateStr} ${timeStr}`;
      let date = new Date(combined);
      if (!isNaN(date.getTime())) return date;
      
      const mdyMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if (mdyMatch) {
        let [, m, d, y] = mdyMatch;
        if (y.length === 2) y = '20' + y;
        const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*(am|pm)?/i);
        if (timeMatch) {
          let [, h, min, ampm] = timeMatch;
          h = parseInt(h, 10);
          if (ampm) {
            if (ampm.toLowerCase() === 'pm' && h !== 12) h += 12;
            if (ampm.toLowerCase() === 'am' && h === 12) h = 0;
          }
          date = new Date(parseInt(y), parseInt(m) - 1, parseInt(d), h, parseInt(min));
          if (!isNaN(date.getTime())) return date;
        }
      }
      
      const isoDate = new Date(dateStr + 'T' + timeStr);
      if (!isNaN(isoDate.getTime())) return isoDate;
      
      return null;
    }

    // Google Drive Sync
    function initGoogleAPI() {
      if (typeof google === 'undefined') {
        setTimeout(initGoogleAPI, 100);
        return;
      }

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '1082696871398-imfkm77japkf0eu4jgjb41gb3cb29m6r.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/drive.file',
        callback: (response) => {
          if (response.access_token) {
            accessToken = response.access_token;
            syncPull();
          }
        }
      });
    }

    function openSyncModal() {
      if (!accessToken) {
        tokenClient.requestAccessToken();
      } else {
        document.getElementById('syncModal').classList.add('show');
      }
    }

    function closeSyncModal() {
      document.getElementById('syncModal').classList.remove('show');
      document.getElementById('syncStatus').textContent = '';
    }

    async function syncNow() {
      if (!accessToken) {
        tokenClient.requestAccessToken();
        return;
      }
      await syncPull();
    }

    async function syncPull() {
      const status = document.getElementById('syncStatus');
      status.textContent = 'Checking Google Drive...';

      try {
        const searchResponse = await fetch(
          'https://www.googleapis.com/drive/v3/files?q=name%3D%22blood-sugar-tracker.json%22%20and%20trashed%3Dfalse&fields=files(id%2CmodifiedTime)&orderBy=modifiedTime%20desc',
          { headers: { 'Authorization': 'Bearer ' + accessToken } }
        );

        const searchData = await searchResponse.json();
        const files = searchData.files || [];

        if (files.length === 0) {
          await syncPush();
          return;
        }

        const fileId = files[0].id;
        const remoteTime = new Date(files[0].modifiedTime).getTime();
        const localTime = new Date(localStorage.getItem('blood-sugar-timestamp') || 0).getTime();

        if (remoteTime > localTime) {
          const downloadResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: { 'Authorization': 'Bearer ' + accessToken } }
          );
          const remoteData = await downloadResponse.json();
          
          appData = remoteData;
          saveData();
          updateUI();
          status.textContent = 'Synced from Google Drive ✓';
        } else {
          await syncPush();
        }

        setTimeout(closeSyncModal, 2000);
      } catch (error) {
        status.textContent = 'Sync failed: ' + error.message;
      }
    }

    async function syncPush() {
      const status = document.getElementById('syncStatus');
      status.textContent = 'Uploading to Google Drive...';

      try {
        const fileContent = JSON.stringify(appData, null, 2);
        const metadata = { name: 'blood-sugar-tracker.json', mimeType: 'application/json' };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([fileContent], { type: 'application/json' }));

        const response = await fetch(
          'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
          {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + accessToken },
            body: form
          }
        );

        if (response.ok) {
          status.textContent = 'Synced to Google Drive ✓';
          setTimeout(closeSyncModal, 2000);
        } else {
          throw new Error('Upload failed');
        }
      } catch (error) {
        status.textContent = 'Sync failed: ' + error.message;
      }
    }

    // Event Listeners
    function setupEventListeners() {
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
      document.getElementById('readingForm').addEventListener('submit', submitReading);
      document.getElementById('tag').addEventListener('change', handleTagChange);
      document.getElementById('reading').addEventListener('input', updateRangeIndicator);
      document.getElementById('timestamp').addEventListener('change', updateTagDropdown);

      document.querySelectorAll('.profile-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.profile-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          selectedProfile = option.dataset.profile;
          document.getElementById('confirmProfile').disabled = false;
        });
      });

      document.getElementById('confirmProfile').addEventListener('click', () => {
        if (selectedProfile) {
          appData.profile = selectedProfile;
          saveData();
          hideProfileModal();
          updateUI();
          checkAndShowVerseModal();
        }
      });

      document.querySelectorAll('.range-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentTimeRange = parseInt(btn.dataset.days);
          saveChartState();
          updateInsights();
          updateChart();
        });
      });

      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          chartView = btn.dataset.view;
          saveChartState();
          updateChart();
        });
      });

      document.getElementById('dateFilter').addEventListener('change', (e) => {
        selectedDate = e.target.value;
        updateChart();
      });

      document.getElementById('tagFilter').addEventListener('change', (e) => {
        selectedTag = e.target.value;
        saveChartState();
        updateChart();
      });

      document.getElementById('recentTagFilter').addEventListener('change', (e) => {
        recentReadingsFilter = e.target.value;
        updateRecentReadings();
      });

      document.getElementById('chartLegend').addEventListener('change', (e) => {
        if (e.target.classList.contains('legend-checkbox')) {
          toggleTag(e.target.dataset.tag);
        }
      });

      document.getElementById('editReadingForm').addEventListener('submit', submitEditReading);
      
      document.getElementById('fullLogTagFilter').addEventListener('change', updateFullLog);
      document.getElementById('fullLogMonthFilter').addEventListener('change', updateFullLog);
    }

    // Start app
    init();

    // Register service worker for offline support
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service worker registered'))
        .catch(err => console.log('Service worker registration failed:', err));
    }
  </script>
</body>
</html>
